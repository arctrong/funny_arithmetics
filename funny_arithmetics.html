<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<!-- <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0"> -->
<head><title>Funny arithmetic</title>
<style>
body, html {
  font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
}
body {
    padding: 15px;
}

p {
    text-align: center;
}

div#hidingBlock {
    width: 100%;
    height: 100%;
    position: fixed;
    z-index: 2;
    display: none;
}
.dialog {
    margin-left: auto;
    margin-right: auto;
    width: max-content;
    margin-top: 70px;
    border: solid black 1px;
    background-color: cornsilk;
    padding: 30px;
}
div#confirmReloadDialog {
    display: none;
}
div#gameResultDialog {
    display: none;
}
div#content {
    margin-left: auto;
    margin-right: auto;
    width: max-content;
}
.status {
    font-size: 30px;
}
#gameDescription {
    display: none;
}
input, input:focus {
    outline: none;
    border: none;
}
#problem, #result {
    font-size: 70px;
}
button {
    font-family: inherit;
    font-size: 25px;
    padding: 3px 10px;
}
#result {
    font-family: inherit;
    height:70px;
    width:120px;
    border-bottom: solid gray 2px;
}
.resultOk {
    color: green;
}
.resultOk::after {
    content: " ‚úÖ";
}
.resultWrong {
/*    text-decoration: line-through; */
    color: red;
}
.resultWrong::after {
    content: " ‚ùå";
}
.reactionOk, .reactionWrong {
    font-size: 40px;
}
.reactionOk {
    color: green;
}
.reactionWrong {
    color: red;
}
</style>
</head>
<body>
<div id="hidingBlock">
    <div id="confirmReloadDialog" class="dialog">
        <p id="confirmReloadDialogText">–ó–∞–∫–æ–Ω—á–∏—Ç—å –∏–≥—Ä—É?</p>
        <p>
            <button type="button" onclick="confirmReloadDialogYes();">–î–∞</button>
            <button type="button" onclick="confirmReloadDialogNo();">–ù–µ—Ç</button>
        </p>
    </div>
    <div id="gameResultDialog" class="dialog">
        <p id="confirmReloadDialogText">–í—ã —Ä–µ—à–∏–ª–∏ –ø—Ä–∏–º–µ—Ä–æ–≤ 
        <span id="summaryTotal" style="color: green;"></span>
        –∑–∞ –≤—Ä–µ–º—è <span id="summaryTime" style="color: blue;"></span>, –æ—à–∏–±–æ—á–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
        <span id="summaryErrors" style="color: red;"></span>.
        </p>
        <p>
            <button type="button" onclick="gameResultDialogClose();"
            id="closeGameResultDialog">–ó–∞–∫—Ä—ã—Ç—å</button>
        </p>
    </div>
</div>
<div id="content">
<p>
<span style="font-size: 30px">üòä</span> <span id="rightScore" class="status" style="color: green;"></span>
&nbsp;&nbsp;&nbsp;&nbsp;
<span style="font-size: 30px">üòû</span> <span id="wrongScore" class="status" style="color: red;"></span>
&nbsp;&nbsp;&nbsp;&nbsp;
<span style="font-size: 30px">üïî</span> <span id="timeElapsed" class="status" style="color: grey;"></span>
</p>
<p id="gameDescription" class="status">–ò–∑ <span id="totalTaskCount" style="color: blue;"></span>
–ø—Ä–∏–º–µ—Ä–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å <span id="remainingTaskCount" style="color: blue;"></span>
</p>
<p id="problem" style="margin: 50px;">
<span id="num1"></span> <span id="op"></span> <span id="num2"></span> = 
<input type="text" id="result" onkeypress="resultEnter();"/>
</p>
<p>
<button type="button" onclick="check();" id="check">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å (Enter)</button>
<button type="button" onclick="startGame();" id="startGame"></button>
</p>

<p><span id="reaction"></span></p>
<p><span id="previousTask" style="font-size: 50px"></span><span
id="previousResult" style="font-size: 50px"></span></p>
</div>

<script>
var ops = [["plus", "+", (n1, n2) => n1 + n2], ["minus", "‚àí", (n1, n2) => n1 - n2], 
    ["multiply", "\u22C5", (n1, n2) => n1 * n2], ["divide", ":", (n1, n2) => n1 / n2]]
var gameTaskCount = 30
var num1 = 0
var num2 = 0
var op = []
var rightScore = 0
var wrongScore = 0

var gameTaskTotal = gameTaskCount

var resultElement = document.getElementById("result")
var timeElapsedElement = document.getElementById('timeElapsed')
var rightScoreElement = document.getElementById("rightScore")
var wrongScoreElement = document.getElementById("wrongScore")
var startGameElement = document.getElementById("startGame")
var reactionElement = document.getElementById("reaction")
var previousTaskElement = document.getElementById("previousTask")
var previousResultElement = document.getElementById("previousResult")
var confirmReloadDialogElement = document.getElementById("confirmReloadDialog")
var hidingBlockElement = document.getElementById("hidingBlock")
var gameDescriptionElement = document.getElementById("gameDescription")
var totalTaskCountElement = document.getElementById("totalTaskCount")
var remainingTaskCountElement = document.getElementById("remainingTaskCount")

var summaryTotalElement = document.getElementById("summaryTotal")
var summaryTimeElement = document.getElementById("summaryTime")
var summaryErrorsElement = document.getElementById("summaryErrors")

var state = "FREE_GAME"

var timerId = null

function renderState() {
    timeElapsedElement.innerHTML = convertDuration(0)
    if (state == "SCORE_GAME") {
        startGameElement.innerText = "–ó–∞–∫–æ–Ω—á–∏—Ç—å –∏–≥—Ä—É"
        startGameElement.onclick = stopGame
        window.addEventListener("beforeunload", beforeUnloadHandler)
        gameTaskTotal = gameTaskCount
        updateGameDescription()
        gameDescriptionElement.style.display = "block"
        startTimer()
    } else {
        startGameElement.innerText = "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É"
        startGameElement.onclick = startGame
        window.removeEventListener("beforeunload", beforeUnloadHandler)
        gameDescriptionElement.style.display = "none"
    }
    renderScores()
    reactionElement.innerText = ""
    previousTaskElement.innerText = ""
    previousResultElement.innerText = ""
    previousResultElement.classList = []
    
    setNewTask()
}

function updateGameDescription() {
    totalTaskCountElement.innerText = gameTaskTotal
    remainingTaskCountElement.innerText = gameTaskTotal - rightScore
}

function startGame() {
    state = "SCORE_GAME"
    renderState()
}

function setNewTask() {

    op = ops[getRandomInt(4)]
    num2 = 1 + getRandomInt(9)
    num1 = 0

    if (op[0] == "minus") {
        num1 = 10 + getRandomInt(10)
    } else if (op[0] == "divide") {
        num1 = (1 + getRandomInt(9)) * num2
    } else if (op[0] == "plus") {
        num1 = 10 + getRandomInt(10) - num2
    } else {
        num1 = 1 + getRandomInt(9)
    }

    document.getElementById("num1").innerText = num1
    document.getElementById("num2").innerText = num2
    document.getElementById("op").innerText = op[1]
        
    if (state == "SCORE_GAME") {
        renderScores()
        updateGameDescription()
    }

    resultElement.value = ""
    resultElement.select()
}

function renderScores() {
    rightScoreElement.innerText = rightScore
    wrongScoreElement.innerText = wrongScore
}

function getRandomInt(max) {
  return Math.floor(Math.random() * max)
}

function resultEnter() {
    if (event.key === "Enter") {
        check()
    }
}

function check() {
    let resultStr = resultElement.value.trim()
    
    if (resultStr.length < 1 || !isOnlyDigits(resultStr) || resultStr.length > 5) {
        reactionElement.classList = ["reactionWrong"]
        reactionElement.innerText = "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —á–∏—Å–ª–æ! ‚òùÔ∏è"
        resultElement.select()
        return false
    }
    
    let result = parseInt(resultStr)
    let expected = op[2](num1, num2)

    previousTaskElement.innerText = num1 + " " + op[1] + " " + num2 + " = "
    previousResultElement.innerText = result
    
    let resultIsRight = false
    
    if (result == expected) {
        reactionElement.classList = ["reactionOk"]
        reactionElement.innerText = "–ú–æ–ª–æ–¥–µ—Ü! üòä"
        previousResultElement.classList = ["resultOk"]
        if (state == "SCORE_GAME") {
            rightScore++
        }
        resultIsRight = true
    } else {
        reactionElement.classList = ["reactionWrong"]
        reactionElement.innerText = "–ü–æ–¥—É–º–∞–π –µ—â–µ! ü§î"
        previousResultElement.classList = ["resultWrong"]
        if (state == "SCORE_GAME") {
            wrongScore++
        }
        gameTaskTotal++
        resultElement.select()
    }
    if (state == "SCORE_GAME") {
        renderScores()
        updateGameDescription()
        if (gameTaskTotal == rightScore) {
            finishGame()
            return
        }
    }
    
    if (resultIsRight) {
        setNewTask()
    }
}

function finishGame() {
    stopTimer()
    summaryTotalElement.innerHTML = gameTaskTotal
    summaryTimeElement.innerHTML = timeElapsedElement.innerHTML
    summaryErrorsElement.innerHTML = wrongScore
    openDialog("gameResultDialog")
    document.getElementById("closeGameResultDialog").focus()
}

function isOnlyDigits(string) {
   for (let i = 0; i < string.length; i++) {
      let ascii = string.charCodeAt(i)
      if (ascii < 48 || ascii > 57) {
         return false
      }
   }
   return true
}

var start

function startTimer() {
    start = Date.now()
    timerId = setInterval(function() {
        timeElapsedElement.innerHTML = convertDuration(Date.now() - start)
    }, 1000)
}

function stopTimer() {
    clearInterval(timerId)
}

function convertDuration(milliseconds) {
    const seconds = Math.floor((milliseconds / 1000) % 60)
    const minutes = Math.floor((milliseconds / 1000 / 60) % 60)
    const hours = Math.floor((milliseconds / 1000 / 60 / 60))
    
    let formattedTime
    
    if (hours == 0) {
        formattedTime = [minutes.toString().padStart(2, "0"),
            seconds.toString().padStart(2, "0")].join(":")
    } else {
          formattedTime = [hours.toString(), minutes.toString().padStart(2, "0"), 
              seconds.toString().padStart(2, "0")].join(":")
    }
    return formattedTime
}

function openDialog(dialogName) {
    document.getElementById(dialogName).style.display = "block"
    hidingBlockElement.style.display = "block"
}

function closeDialog(dialogName) {
    document.getElementById(dialogName).style.display = "none"
    hidingBlockElement.style.display = "none"
}

function stopGame() {
    openDialog("confirmReloadDialog")
}

function beforeUnloadHandler(event) {
    event.preventDefault()
    event.returnValue = true
    return ""
}

function confirmReloadDialogYes() {
    window.removeEventListener("beforeunload", beforeUnloadHandler)
    location.reload()
}

function confirmReloadDialogNo() {
    closeDialog("confirmReloadDialog")
    resultElement.select()
}

function gameResultDialogClose() {
    closeDialog("gameResultDialog")
    window.removeEventListener("beforeunload", beforeUnloadHandler)
    location.reload()
}

renderState()

</script>

</body>
</html>
